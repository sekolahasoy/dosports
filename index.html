<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/png"
      href="https://cdn-icons-png.flaticon.com/128/1169/1169096.png">

<title>Sports Schedule</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* -----------------------------
   GLOBAL
------------------------------*/
body {
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
    background: #f4f6f8;
}

header {
    background: linear-gradient(90deg, #1C4D8D, #3BC1A8);
    color: #fff;
    padding: 18px;
    text-align: center;
}

.container {
    max-width: 1200px;
    margin: 20px auto;
    padding: 0 16px;
}

.status {
    text-align: center;
    color: #555;
    margin-bottom: 20px;
}


.site-title {
    margin: 0;
    font-size: 28px;
    font-weight: 800;
}

.site-title a {
    text-decoration: none;
    background: #fff;
    background-clip: text;
    color: transparent;
    cursor: pointer;
}

.site-title a:hover {
    opacity: 0.85;
}
/* -----------------------------
   GRID
------------------------------*/
#grid {
    display: grid;
    gap: 16px;
    grid-template-columns: repeat(var(--cards-per-row, 2), minmax(0, 1fr));
}

@media (max-width: 1200px) {
    :root { --cards-per-row: 2; }
}

@media (max-width: 920px) {
    :root { --cards-per-row: 1; }
}


/* -----------------------------
   CARD + FLIP
------------------------------*/
.card {
    border-radius: 12px;
    overflow: hidden;
    transition: box-shadow 0.25s ease, transform 0.25s ease;
}

.card:hover {
    box-shadow: 6px 6px 0 #3BC1A8;
    transform: translate(-2px, -2px);
}


.card-inner {
    position: relative;
    width: 100%;
    min-height: 175px;
    transform-style: preserve-3d;
    transition: transform 0.6s ease;
}

.card.is-flipped .card-inner {
    transform: rotateY(180deg);
}

.card-face {
    position: absolute;
    inset: 0;
    background: #fff;
    border-radius: 12px;
    padding: 16px;
    backface-visibility: hidden;
    box-shadow: 0 4px 10px rgba(0,0,0,0.06);
}

/* -----------------------------
   FRONT
------------------------------*/
.card-front {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.league {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #444;
}

.league img {
    width: 28px;
    height: 28px;
}

.match-time {
    font-size: 13px;
    color: #666;
}

.teams {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 13px;
    margin-bottom: 13px;
}

.teamsback {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.team {
    display: flex;
    align-items: center;
    gap: 8px;
}

.team img {
    width: 36px;
    height: 36px;
}

.team-name {
    font-size: 14px;
    font-weight: bold;
}

.vs {
    font-weight: bold;
    color: #888;
}

.meta {
    display: flex;
   align-items: center;
    justify-content: space-between;
}

.meta-left,
.meta-right {
    display: flex;
    align-items: center;
}

/* Prevent badge from stretching */
.meta-left .badge {
    white-space: nowrap;
}


/* -----------------------------
   BACK
------------------------------*/
.card-back {
    transform: rotateY(180deg);
    overflow-y: auto;
}

.card-back h4 {
    margin: 0 0 10px;
}

.channels {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}


.channels button {
position: relative;
  border-radius: 6px;
    background: linear-gradient(45deg, #3BC1A8, #1C4D8D);
    color: #fff;
    font-weight: bold;
    cursor: pointer;
     border: none;
      padding: 10px;
    margin-bottom: 8px;
    flex: 1 1 calc(25% - 8px);
}
.channels button:hover {
    opacity: 0.85;
}

/* tooltip bubble */
.channels button::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 115%;
    left: 50%;
    transform: translateX(-50%) translateY(4px);

    background: rgba(0, 0, 0, 0.85);
    color: #fff;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 12px;
    white-space: nowrap;

    opacity: 0;
    pointer-events: none;
    transition: opacity 0.15s ease, transform 0.15s ease;
    z-index: 10;
}

/* small arrow */
.channels button::before {
    content: "";
    position: absolute;
    bottom: 105%;
    left: 50%;
    transform: translateX(-50%);

    border-width: 6px;
    border-style: solid;
    border-color: rgba(0, 0, 0, 0.85) transparent transparent transparent;

    opacity: 0;
    transition: opacity 0.15s ease;
}

/* show tooltip on hover */
.channels button:hover::after,
.channels button:hover::before {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
} 

/* -----------------------------
   BADGES
------------------------------*/
.badge {
    font-size: 11px;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 999px;
    letter-spacing: 0.4px;
    color: #000;
    display: inline-block;
}

/* LIVE badge */
.badge.live {
    background: #A8DF8E;
    animation: liveBlink 1.2s infinite;
}

/* UPCOMING badge */
.badge.upcoming {
    background: #FFAAB8;
}

/* Blink animation */
@keyframes liveBlink {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.35;
    }
}

header form {
    margin-top: 12px;
    display: flex;
    justify-content: center;
}

#searchInput {
    width: 100%;
    max-width: 420px;
    padding: 10px 14px;
    border-radius: 8px;
    border: none;
    outline: none;
    font-size: 14px;
}

#searchInput:focus {
    box-shadow: 0 0 0 2px #3BC1A8;
}


/* -----------------------------
   FOOTER
------------------------------*/
footer {
    text-align: center;
    font-size: 12px;
    color: #777;
    padding: 20px;
}
/* -----------------------------
   POPUP PLAYER
------------------------------*/
.player-channels {
    position: absolute;
    bottom: 14px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 8px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 5;
}

.player-box:hover .player-channels,
.player-box:hover .player-close {
    opacity: 1;
    pointer-events: auto;
}

.player-modal {
    position: fixed;
    inset: 0;
    z-index: 9999;
}

.player-modal.hidden {
    display: none;
}

.player-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
}


.player-box {
    position: relative;
    width: 90%;
    max-width: 960px;
    margin: 5vh auto;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
    z-index: 1;
}

.player-box:hover .player-close {
    opacity: 1;
    pointer-events: auto;
}

.player-box iframe {
    width: 100%;
    height: 70vh;
    border: none;
}

.player-close {
    position: absolute;
    top: 10px;
    right: 12px;
    z-index: 5;
    background: rgba(0,0,0,0.7);
    color: #fff;
    border: none;
    font-size: 18px;
    cursor: pointer;
    border-radius: 50%;
    width: 32px;
    height: 32px;

    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s ease;
}


.player iframe {
    margin-top: 12px;
    border-radius: 10px;
}

.player-box {
    position: relative;
    width: 90vw;
    max-width: 1100px;
    aspect-ratio: 16 / 9;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
}

#popupPlayer iframe {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    border: 0;
}


</style>
</head>
<body>

<header>
      <h1 class="site-title">
        <a href="#" id="resetSearch">ðŸ“… Sports Schedule</a>
    </h1>
    <p>Search matches then click the cards to watch!</p>
        <form id="searchForm">
        <input
            type="text"
            id="searchInput"
            placeholder="Search league, sport, or team..."
            autocomplete="off"
        />
    </form>
</header>

<div class="container">
    <div id="status" class="status">Loading events...</div>
    <div id="grid" class="grid"></div>
</div>

<footer>
    Data source: beta.adstrim.ru
</footer>
<div id="playerModal" class="player-modal hidden">
    <div class="player-overlay"></div>

    <div class="player-box" id="playerBox">
        <button class="player-close">âœ•</button>

        <!-- CHANNEL OVERLAY -->
        <div class="player-channels"></div>

        <!-- VIDEO -->
        <div id="popupPlayer"></div>
    </div>
</div>



<script>
/* -----------------------------
   GLOBAL STATE
------------------------------*/
let allEvents = [];
let activeFlippedCard = null;
let currentChannels = [];
let currentChannelIndex = 0;


const API_URL = "https://beta.adstrim.ru/api/events/";
const gridEl = document.getElementById("grid");
const statusEl = document.getElementById("status");
const searchInput = document.getElementById("searchInput");
const COUNTDOWN_THRESHOLD_MIN = 25;
const COUNTDOWN_THRESHOLD_MS = COUNTDOWN_THRESHOLD_MIN * 60 * 1000;
const modal = document.getElementById("playerModal");
const popupPlayer = document.getElementById("popupPlayer");
const closeBtn = document.querySelector(".player-close");
const overlay = document.querySelector(".player-overlay");
const playerBox = document.querySelector(".player-box");
const EXCLUDED_TOURNAMENT_IDS = ["266"];
const SPORT_TV_GUIDE_MAP = {
    "league1.png": "17", // Premier League
    "league2.png": "8",  // LaLiga
    "league3.png": "23", // Serie A
    "league4.png": "35", // Bundesliga
    "league6.png": "34",  // Ligue 1
    "league19.png": "7",
    "league26.png": "132",
    "league76.png": "2363",
    "league77.png": "2363"
};

/* -----------------------------
   TIME HELPERS
------------------------------*/
function formatLocalTime(unixSeconds) {
    const date = new Date(unixSeconds * 1000);
    const now = new Date();

    // Normalize dates (ignore time)
    const today = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate()
    );

    const eventDay = new Date(
        date.getFullYear(),
        date.getMonth(),
        date.getDate()
    );

    const diffDays = Math.round(
        (eventDay - today) / (24 * 60 * 60 * 1000)
    );

    const timeStr = date.toLocaleTimeString(undefined, {
        hour: "2-digit",
        minute: "2-digit"
    });

    if (diffDays === 0) {
        return `Today at ${timeStr}`;
    }

    if (diffDays === 1) {
        return `Tomorrow at ${timeStr}`;
    }

    return date.toLocaleString(undefined, {
        weekday: "short",
        month: "short",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
    });
}


function isUpcomingOrLive(event) {
    const now = Date.now();
    const start = event.timestamp * 1000;
    const durationMs = (event.duration || 0) * 60000;
    return now < start + durationMs;
}

function isLive(event) {
    const now = Date.now();
    const start = event.timestamp * 1000;
    const end = start + (event.duration || 0) * 60000;
    return now >= start && now < end;
}

function getBadgeState(event) {
    const now = Date.now();
    const start = event.timestamp * 1000;
    const end = start + (event.duration || 0) * 60000;

    if (now >= start && now < end) {
        return { type: "live", text: "LIVE" };
    }

    const diff = start - now;

    if (diff <= COUNTDOWN_THRESHOLD_MS) {
        const totalSeconds = Math.floor(diff / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;

        return {
            type: "countdown",
            text: `Starts in ${minutes}:${seconds.toString().padStart(2, "0")}`
        };
    }

    return { type: "upcoming", text: "UPCOMING" };
}

function getTournamentId(event) {
    const img = event.league_image || "";

    // 1ï¸âƒ£ Try SofaScore format first
    const sofaMatch = img.match(/unique-tournament\/(\d+)\//);
    if (sofaMatch) {
        return sofaMatch[1];
    }

    // 2ï¸âƒ£ Fallback: Sport-TV-Guide mapping
    const fileName = img.split("/").pop();
    if (SPORT_TV_GUIDE_MAP[fileName]) {
        return SPORT_TV_GUIDE_MAP[fileName];
    }

    return null; // unknown tournament
}
      
function sortEvents(events) {
    const PINNED_IDS = ["17", "8", "23", "35", "34", "7", "132", "2363"];

    function tournamentRank(event) {
        const id = getTournamentId(event);
        const index = PINNED_IDS.indexOf(id);
        return index === -1 ? PINNED_IDS.length : index;
    }

    return [...events].sort((a, b) => {
        const aLive = isLive(a);
        const bLive = isLive(b);

        /* 1ï¸âƒ£ LIVE always first */
        if (aLive && !bLive) return -1;
        if (!aLive && bLive) return 1;

        /* 2ï¸âƒ£ Pinned tournaments (league priority) */
        const rankDiff = tournamentRank(a) - tournamentRank(b);
        if (rankDiff !== 0) return rankDiff;

        /* 3ï¸âƒ£ Earlier kickoff */
        return a.timestamp - b.timestamp;
    });
}


      
function isExcludedTournament(event) {
    const img = event.league_image || "";
    return EXCLUDED_TOURNAMENT_IDS.some(id =>
        img.includes(`/unique-tournament/${id}/`)
    );
}

/* -----------------------------
   POPUP PLAYER
------------------------------*/
function openPlayer(channels) {
    if (!channels.length) return;

    currentChannels = channels;
    currentChannelIndex = 0;

    renderPlayerChannels();
    loadChannel(currentChannelIndex);

    modal.classList.remove("hidden");
}
function loadChannel(index) {
    const ch = currentChannels[index];
    if (!ch) return;

    const encoded = encodeURIComponent(ch.name);

    popupPlayer.innerHTML = `
        <iframe
            src="https://topembed.pw/channel/${encoded}"
            allowfullscreen
        ></iframe>
    `;
}
function renderPlayerChannels() {
    const container = document.querySelector(".player-channels");
      if (!container) return;
    container.innerHTML = "";

    currentChannels.forEach((ch, index) => {
        const btn = document.createElement("button");
        btn.textContent = `LIVE ${index + 1}`;
        btn.setAttribute("data-tooltip", ch.name);

        if (index === currentChannelIndex) {
            btn.classList.add("active");
        }

        btn.onclick = e => {
            e.stopPropagation();
            currentChannelIndex = index;
            loadChannel(index);
            renderPlayerChannels();
        };

        container.appendChild(btn);
    });
}



function closePlayer() {
    popupPlayer.innerHTML = ""; // stop playback
    modal.classList.add("hidden");
}

closeBtn.onclick = closePlayer;
document.addEventListener("keydown", e => {
    if (e.key === "Escape" && !modal.classList.contains("hidden")) {
        closePlayer();
    }
});

playerBox.addEventListener("touchstart", () => {
    const channels = document.querySelector(".player-channels");

    channels.style.opacity = "1";
    channels.style.pointerEvents = "auto";
    closeBtn.style.opacity = "1";
    closeBtn.style.pointerEvents = "auto";

    clearTimeout(playerBox._hideTimer);
    playerBox._hideTimer = setTimeout(() => {
        channels.style.opacity = "0";
        channels.style.pointerEvents = "none";
        closeBtn.style.opacity = "0";
        closeBtn.style.pointerEvents = "none";
    }, 3000);
});

/* -----------------------------
   RENDER EVENTS
------------------------------*/
function renderEvents(events) {
    gridEl.innerHTML = "";

    if (!events.length) {
        statusEl.textContent = "No results found.";
        return;
    }

    statusEl.textContent = `Showing ${events.length} events`;

    events.forEach(event => {
        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
        <div class="card-inner">
            <div class="card-face card-front">
                <div class="league">
                    <img src="${event.league_image}"
                    onerror="this.onerror=null;this.src='https://cdn-icons-png.flaticon.com/128/3098/3098946.png'">
                    <span>${event.league} â€¢ ${event.sport}</span>
                </div>
                
                <div class="teams">
                    <div class="team">
                        <img src="${event.home_team_image}"
                        onerror="this.onerror=null;this.src='https://cdn-icons-png.flaticon.com/128/11743/11743404.png'">
                        <span class="team-name">${event.home_team}</span>
                    </div>

                    <div class="vs">VS</div>

                    <div class="team">
                        <span class="team-name">${event.away_team}</span>
                        <img src="${event.away_team_image}"
                        onerror="this.onerror=null;this.src='https://cdn-icons-png.flaticon.com/128/12183/12183336.png'">
                    </div>
                </div>
                
                <div class="meta">
                  ${(() => {
                      const badge = getBadgeState(event);
                  
                      if (badge.type === "live") {
                          return `
                              <div class="meta-left">
                              </div>
                              <div class="meta-right">
                                  <span class="badge live">LIVE</span>
                              </div>
                          `;
                      }
                  
                      if (badge.type === "countdown") {
                          return `
                              <div class="meta-left">
                              <div class="match-time">
                                   ðŸ•’ ${formatLocalTime(event.timestamp)}
                              </div>
                              </div>
                              <div class="meta-right">
                                  <span class="badge upcoming countdown"
                                        data-start="${event.timestamp}">
                                      ${badge.text}
                                  </span>
                              </div>
                          `;
                      }
                  
                      return `
                          <div class="meta-left">
                              <div class="match-time">
                                   ðŸ•’ ${formatLocalTime(event.timestamp)}
                              </div>

                          </div>
                          <div class="meta-right">
                              <span class="badge upcoming">UPCOMING</span>
                          </div>
                      `;
                  })()}
                </div>

            </div>

            <div class="card-face card-back">
                <div class="meta">
                  ${(() => {
                      const badge = getBadgeState(event);
                  
                      if (badge.type === "live") {
                          return `
                              <div class="meta-left">
                                  <span class="badge live">LIVE</span>

                              </div>
                          `;
                      }
                  
                      if (badge.type === "countdown") {
                          return `
                              <div class="meta">
                                  <span class="badge upcoming countdown"
                                        data-start="${event.timestamp}">
                                      ${badge.text}
                                  </span>

                              </div>
                          `;
                      }
                  
                      return `
                          <div class="meta">
                              <span class="badge upcoming">UPCOMING</span>
                          </div>
                      `;
                  })()}
                </div>
                <br>
                <div class="teamsback">
                    <div class="team">
                        <img src="${event.home_team_image}"
                        onerror="this.onerror=null;this.src='https://cdn-icons-png.flaticon.com/128/11743/11743404.png'">
                        <span class="team-name">${event.home_team}</span>
                    </div>

                    <div class="vs">VS</div>

                    <div class="team">
                        <span class="team-name">${event.away_team}</span>
                        <img src="${event.away_team_image}"
                        onerror="this.onerror=null;this.src='https://cdn-icons-png.flaticon.com/128/12183/12183336.png'">
                    </div>
                </div>
                <br>
                  <button class="watch-now">â–¶ Watch Now</button>
            </div>
        </div>`;

        /* ---- FLIP LOGIC ---- */
        card.addEventListener("click", e => {
            if (e.target.tagName === "BUTTON") return;

            if (activeFlippedCard && activeFlippedCard !== card) {
                activeFlippedCard.classList.remove("is-flipped");
            }

            card.classList.toggle("is-flipped");
            activeFlippedCard = card.classList.contains("is-flipped") ? card : null;
        });

/* -----------------------------
   LOAD EVENTS
------------------------------*/
async function loadEvents() {
    try {
        statusEl.textContent = "Loading events...";
        const res = await fetch(API_URL);
        const json = await res.json();

        if (json.status !== "success") throw new Error("API error");

            allEvents = sortEvents(
                    json.data
                        .filter(isUpcomingOrLive)
                        .filter(event => !isExcludedTournament(event))
              );
          
          renderEvents(allEvents);

    } catch (err) {
        console.error(err);
        statusEl.textContent = "Failed to load events.";
    }
}

/* -----------------------------
   SEARCH
------------------------------*/
searchInput.addEventListener("input", () => {
    const q = searchInput.value.trim().toLowerCase();

    if (!q) {
        renderEvents(sortEvents(allEvents));
        return;
    }

    const filtered = allEvents.filter(event => {
        const league = (event.league || "").toLowerCase();
        const sport = (event.sport || "").toLowerCase();
        const home  = (event.home_team || "").toLowerCase();
        const away  = (event.away_team || "").toLowerCase();

        return (
            league.includes(q) ||
            sport.includes(q) ||
            home.includes(q) ||
            away.includes(q)
        );
    });

    renderEvents(sortEvents(filtered));
});

/* -----------------------------
   AUTO REMOVE FINISHED MATCHES
------------------------------*/
setInterval(() => {
    const updated = sortEvents(
        allEvents.filter(isUpcomingOrLive)
    );

    if (updated.length !== allEvents.length) {
        allEvents = updated;
        activeFlippedCard = null;
        renderEvents(allEvents);
    }
}, 60 * 1000);


setInterval(() => {
    document.querySelectorAll(".badge.countdown").forEach(badge => {
        const start = badge.dataset.start * 1000;
        const diff = start - Date.now();

        if (diff <= 0) {
            badge.textContent = "LIVE";
            badge.classList.remove("upcoming", "countdown");
            badge.classList.add("live");
            return;
        }

        const totalSeconds = Math.floor(diff / 1000);
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;

        badge.textContent = `Starts in ${minutes}:${seconds
            .toString()
            .padStart(2, "0")}`;
    });
}, 1000);

document.getElementById("resetSearch").onclick = e => {
    e.preventDefault();

    searchInput.value = "";
    activeFlippedCard = null;

    renderEvents(sortEvents(allEvents));
};
/* -----------------------------
   INIT
------------------------------*/
loadEvents();
</script>


</body>
</html>
